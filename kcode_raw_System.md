# Kcode 계약 시스템 명세서 (v2.0.0)

> 변경 이력
> - v1.0.0 : 법령/법위반 기본 시스템 (인라인 문법)
> - v2.0.0 : 계약 시스템 전면 개편
>   - 헌법/법률/규정/법령/법위반 5계층 도입
>   - 블록 문법으로 전환 (조항/법령끝/법위반끝/규정끝)
>   - 파일 내장 함수 체계 추가

-----

## 1. 개요

Kcode 계약 시스템은 Design by Contract(DbC) 개념을
한국어 법률 용어 계층으로 표현한 런타임 계약 검증 시스템입니다.

v2.0.0부터 실제 법률 체계와 동일한 5단계 계층 구조를 가집니다.

```
헌법    <- 모든 파일, 모든 함수 (최상위 전역)
법률    <- 현재 파일 전체
규정    <- 현재 파일 내 특정 객체의 모든 메서드
법령    <- 특정 함수 하나 (사전조건)
법위반  <- 특정 함수 하나 (사후조건)
```

우선순위 평가 순서: 헌법 → 법률 → 규정 → 법령 → 법위반
상위 계층에서 중단 제재 발생 시 하위 계층은 평가하지 않습니다.

-----

## 2. 계층별 문법

### 2-1. 헌법 — 모든 파일 전역 적용 (인라인)

```
헌법 [조건], [제재]
```

```han
헌법 입력 != 없음, 중단
헌법 반환값 != 없음, 경고
```

- 파일 어디에 선언해도 전체 프로그램에 적용
- 가장 짧고 강한 계층으로 인라인 유지

-----

### 2-2. 법률 — 현재 파일 전체 적용 (인라인)

```
법률 [조건], [제재]
```

```han
법률 값 >= 0, 경고
법률 입력 != 없음, 보고
```

- 선언된 파일 내 모든 함수/정의에 적용
- #포함 으로 가져온 파일에는 적용 안 됨

-----

### 2-3. 규정 — 특정 객체 전체 메서드 적용 (블록)

```
규정 [객체명]:
    조항 [조건]
    [제재]
규정끝
```

```han
규정 계좌:
    조항 잔액 >= 0
    회귀 초기상태
규정끝
```

- 해당 객체의 모든 메서드 진입 시 자동 적용

-----

### 2-4. 법령 — 특정 함수 사전조건 (블록)

```
법령 [함수명]:
    조항 [조건]
    [제재]
법령끝
```

```han
법령 나누기:
    조항 나 != 0
    중단
법령끝

법령 제곱근계산:
    조항 값 >= 0
    대체 -1
법령끝
```

- 함수 실행 전 조건 검사 (사전조건 Precondition)

-----

### 2-5. 법위반 — 특정 함수 사후조건 (블록)

```
법위반 [함수명]:
    조항 [조건]
    [제재]
법위반끝
```

```han
법위반 나누기:
    조항 반환값 != 없음
    경고
법위반끝
```

- 함수 실행 후 결과 검사 (사후조건 Postcondition)
- 반환값 키워드로 함수 반환값 참조 가능

-----

### 2-6. 복원지점

```
복원지점 [이름]
```

```han
복원지점 초기상태

규정 계좌:
    조항 잔액 >= 0
    회귀 초기상태
규정끝
```

-----

## 3. 제재 종류

| 제재 | 동작 | 실행 계속 |
|------|------|---------|
| 경고 | stderr 메시지 출력 | 계속 |
| 보고 | kcode_contract.log 기록 | 계속 |
| 중단 | 오류 발생 → 실패시 블록 전달 | 중단 |
| 회귀 [지점명] | 복원지점 스냅샷으로 상태 복원 후 중단 | 중단 |
| 대체 [값] | 지정값 반환 후 함수 종료 | 종료 |
| 대체 [함수명] | 지정 함수를 대신 실행 | 대체 |

-----

## 4. 종합 코드 예시

### 4-1. 나누기 함수

```han
법령 나누기:
    조항 나 != 0
    중단
법령끝

법위반 나누기:
    조항 반환값 != 없음
    경고
법위반끝

함수 나누기(정수 가, 정수 나):
    반환 가 / 나
```

### 4-2. 계층 전체 사용 예시

```han
// 전체 프로그램
헌법 입력 != 없음, 중단

// 이 파일 전체
법률 값 >= 0, 경고

// 계좌 객체 전체
복원지점 초기상태

규정 계좌:
    조항 잔액 >= 0
    회귀 초기상태
규정끝

// 특정 함수만
법령 출금:
    조항 금액 > 0
    중단
법령끝

법위반 출금:
    조항 잔액 >= 0
    중단
법위반끝

객체 계좌:
    정수 잔액 = 0

    정의 출금(자신, 정수 금액):
        자신.잔액 -= 금액
```

-----

## 5. 파일 내장 함수 체계

### 5-1. 기본 입출력

| 함수 | 설명 | 반환 |
|------|------|------|
| 파일열기("경로", "읽기") | 읽기 모드로 열기 | 파일 |
| 파일열기("경로", "쓰기") | 쓰기 모드로 열기 | 파일 |
| 파일열기("경로", "추가") | append 모드로 열기 | 파일 |
| 파일닫기(파일) | 파일 닫기 | 없음 |
| 파일읽기(파일) | 전체 내용 읽기 | 문자 |
| 파일줄읽기(파일) | 한 줄 읽기 | 문자 |
| 파일쓰기(파일, 내용) | 내용 쓰기 | 없음 |
| 파일줄쓰기(파일, 내용) | 줄바꿈 포함 쓰기 | 없음 |

### 5-2. 파일/폴더 정보

| 함수 | 설명 | 반환 |
|------|------|------|
| 파일있음("경로") | 존재 여부 확인 | 논리 |
| 파일크기("경로") | 파일 크기 바이트 | 정수 |
| 파일목록("폴더경로") | 폴더 내 파일 목록 | 배열 |
| 폴더만들기("경로") | 폴더 생성 | 없음 |
| 파일지우기("경로") | 파일 삭제 | 없음 |
| 파일복사("원본", "대상") | 파일 복사 | 없음 |
| 파일이동("원본", "대상") | 파일 이동/이름변경 | 없음 |
| 파일이름("경로") | 경로에서 파일명 추출 | 문자 |
| 파일확장자("경로") | 확장자 추출 | 문자 |

### 5-3. 편의 함수

| 함수 | 설명 | 반환 |
|------|------|------|
| 파일전체읽기("경로") | 열기+읽기+닫기 한번에 | 문자 |
| 파일전체쓰기("경로", 내용) | 열기+쓰기+닫기 한번에 | 없음 |

### 5-4. 파일 함수 사용 예시

```han
// 기본 사용
문자 내용 = 파일전체읽기("data.txt")
출력(내용)

// 줄 단위 읽기
파일 f = 파일열기("log.txt", "읽기")
동안 참:
    문자 줄 = 파일줄읽기(f)
    만약 줄 == 없음:
        멈춤
    출력(줄)
파일닫기(f)

// 폴더 탐색
배열 목록 = 파일목록("./데이터")
각각 항목 안에 목록:
    출력(파일이름(항목))

// 파일 계약 연동
법률 파일있음("설정.txt") == 참, 중단

문자 설정 = 파일전체읽기("설정.txt")
```

-----

## 6. 구현 단계 현황 (v2.0.0 기준)

| 단계 | 파일 | 작업 내용 | 상태 |
|------|------|---------|------|
| 1 | klexer.h/c | 헌법/법률/규정/조항/법령끝/법위반끝/규정끝 + 파일 함수 토큰 | 예정 |
| 2 | kparser.h/c | NODE_CONSTITUTION/LAW/REGULATION + 블록 파싱 변경 | 예정 |
| 3 | kinterp.h/c | 계층 우선순위 평가 + 파일 내장 함수 17종 구현 | 예정 |
| 4 | kcodegen.h/c | 새 계층 노드 C 코드 변환 | 예정 |
| 5 | readme.md / raw | 최종 문서화 | 예정 |

-----

## 7. 가속기 블록

CuPy/PyTorch 스크립트로 위임 실행하며, 미설치 시 NumPy로 자동 폴백됩니다.

```han
가속기:
    행렬곱(A, B)
가속기끝
```

-----

| 항목 | 내용 |
|------|------|
| 프로젝트 | Kcode 계약 시스템 명세 |
| License | MIT / zerojat7 |
| Github | https://zerojat7-ui.github.io/KCODE |
| 명세 버전 | v2.0.0 |

-----
