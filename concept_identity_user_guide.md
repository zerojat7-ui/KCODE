# Kcode Concept Identity / Vector Space

# 사용자 설정 가이드

> 이 문서는 의미 기반 벡터 추론 엔진(v20.5.0 예정)에서  
> **개발자(사용자)가 직접 설정해야 하는 영역**만을 다룹니다.  
> 엔진이 자동 처리하는 부분은 포함하지 않습니다.
>
> ⚠️ **구현 상태**: 미구현 (설계 문서) — 온톨로지 4~8회차 완료 후 착수 예정  
> ⚠️ **선행 조건**: v21.0.0 온톨로지 8회차 완료 필요

-----

## 설정 전 전체 구조 이해

```
개발자가 설정하는 영역
│
├── [Layer 1]  Semantic Layer    ← 개념 · 관계 · 제약 정의
├── [Layer 2.1] Ontology DB      ← 지식 스키마 제공
├── [Layer 2.2] Vector DB        ← 벡터화 방식 선택
└── [Layer 2.3] State/Log DB     ← 로그 · 학습 정책 설정
│
▼
엔진이 자동 처리 (Layer 3 ~ 10)
```

> **핵심 원칙**: 개발자는 *무엇을 알고 있는지*와 *어떻게 기억할지*를 정의합니다.  
> 계산·추론·검증·복원은 엔진이 처리합니다.

-----

## Layer 1 — Semantic Layer (의미 레이어)

### 역할

입력을 개념 구조로 해석하기 위한 기반 정의입니다.  
엔진은 이 정의를 바탕으로 모든 추론을 수행합니다.

### 설정 항목 4가지

|항목    |설명                    |필수 여부|
|------|----------------------|-----|
|개념 정의 |시스템이 다루는 사물/상태의 이름과 속성|✅ 필수 |
|관계 모델 |개념 간 연결 방향과 의미        |✅ 필수 |
|의미 스코프|이 온톨로지가 유효한 범위        |선택   |
|제약 조건 |반드시 지켜야 할 규칙 선언       |권장   |

-----

### 1-1. 개념 정의

시스템에 등장하는 모든 사물·상태·행위를 개념으로 선언합니다.

```han
온톨로지 "시스템이름":

    // 기본 개념 — 속성 없음
    개념 사용자

    // 속성 포함 개념
    개념 기계 속성=[이름, 상태, 온도, 위치]
    개념 제품 속성=[ID, 품질등급, 생산시간]
    개념 불량품 속성=[원인, 감지시간, 심각도]

온톨로지끝
```

**속성 타입 지정 (선택)**

```han
개념 기계 속성=[
    이름:문자,
    상태:문자,
    온도:실수,
    가동중:논리
]
```

**개념 상속**

```han
개념 장비          // 부모 개념
개념 기계 상위=장비  // 기계는 장비의 하위 개념
개념 로봇 상위=기계  // 로봇은 기계의 하위 개념
```

-----

### 1-2. 관계 모델

개념과 개념 사이의 연결을 방향과 의미로 선언합니다.

```han
온톨로지 "공장지식":

    // 단방향 관계: A → 관계명 → B
    관계 기계 → 생산 → 제품
    관계 기계 → 감지 → 불량품
    관계 작업자 → 운영 → 기계

    // 역방향 관계 자동 생성 옵션
    관계 기계 → 포함 → 부품 역=부품속于기계

온톨로지끝
```

**관계 속성 추가**

```han
관계 기계 → 생산 → 제품 속성=[생산량, 생산시간]
```

-----

### 1-3. 의미 스코프

온톨로지가 적용되는 범위를 제한합니다.  
여러 온톨로지를 사용할 때 충돌을 방지합니다.

```han
온톨로지 "공장A_1호라인" 스코프=생산라인:
    개념 기계 속성=[이름, 온도]
온톨로지끝

온톨로지 "공장A_품질관리" 스코프=품질:
    개념 제품 속성=[ID, 등급]
온톨로지끝
```

-----

### 1-4. 제약 조건

반드시 참이어야 하는 조건을 선언합니다.  
엔진의 Validation Layer(Layer 7)가 이 조건을 자동 검사합니다.

```han
온톨로지 "공장지식":

    개념 기계 속성=[온도:실수, 압력:실수]

    // 물리적 안전 제약
    제약 온도 < 150.0
    제약 압력 < 10.0
    제약 온도 >= 0.0

    // 논리 제약
    제약 상태 != 없음
    제약 이름 != ""

온톨로지끝
```

> **주의**: 제약 위반 시 엔진이 자동으로 FAIL 판정을 내립니다.  
> 계약 시스템(헌법/법률)과 함께 사용하면 제재까지 자동 적용됩니다.

-----

### Layer 1 전체 예시

```han
온톨로지 "스마트공장":

    // 개념 정의
    개념 장비
    개념 기계 상위=장비 속성=[이름:문자, 온도:실수, 가동중:논리]
    개념 센서 상위=장비 속성=[ID:문자, 측정값:실수, 단위:문자]
    개념 제품 속성=[ID:문자, 품질등급:문자, 생산시간:정수]
    개념 불량품 상위=제품 속성=[원인:문자, 감지시간:정수]
    개념 작업자 속성=[이름:문자, 권한등급:정수]

    // 관계 모델
    관계 기계 → 생산 → 제품
    관계 기계 → 감지 → 불량품
    관계 센서 → 측정 → 기계
    관계 작업자 → 운영 → 기계

    // 제약 조건
    제약 온도 < 150.0
    제약 온도 >= -10.0
    제약 권한등급 >= 1
    제약 권한등급 <= 5

온톨로지끝
```

-----

## Layer 2.1 — Ontology DB (지식 스키마)

### 역할

엔진이 참조할 지식 베이스를 외부 파일로 제공합니다.  
Layer 1의 K문법 선언과 병행하거나 단독으로 사용할 수 있습니다.

### 지원 포맷

|포맷     |확장자      |특징             |권장 상황       |
|-------|---------|---------------|------------|
|K문법    |`.han`   |가장 간단, Kcode 전용|신규 프로젝트     |
|JSON-LD|`.jsonld`|웹 표준, 읽기 쉬움    |웹 서비스 연동    |
|CSV    |`.csv`   |스프레드시트 호환      |데이터 목록 대량 입력|
|Turtle |`.ttl`   |RDF 표준, 간결     |외부 온톨로지 연동  |
|OWL/XML|`.owl`   |풍부한 표현력        |기존 OWL 자산 활용|

-----

### 2.1-1. JSON-LD로 지식 제공

```json
{
  "@context": {
    "기계": "http://kcode.io/factory#기계",
    "온도": "http://kcode.io/factory#온도",
    "상태": "http://kcode.io/factory#상태"
  },
  "@graph": [
    {
      "@id": "기계:A001",
      "@type": "기계",
      "온도": 72.5,
      "상태": "가동중"
    },
    {
      "@id": "기계:A002",
      "@type": "기계",
      "온도": 65.0,
      "상태": "대기"
    }
  ]
}
```

**Kcode에서 불러오기**

```han
온톨로지불러오기("factory_data.jsonld", 형식=JSON-LD)
```

-----

### 2.1-2. CSV로 인스턴스 대량 입력

```csv
ID,유형,온도,상태,위치
A001,기계,72.5,가동중,1공장
A002,기계,65.0,대기,1공장
S001,센서,0.0,정상,A001
```

**Kcode에서 불러오기**

```han
온톨로지불러오기("machines.csv", 형식=CSV, 유형열="유형")
```

-----

### 2.1-3. Turtle(.ttl)로 관계 정의

```turtle
@prefix kc: <http://kcode.io/factory#> .

kc:기계A001 a kc:기계 ;
    kc:온도 72.5 ;
    kc:상태 "가동중" ;
    kc:생산 kc:제품X001 .

kc:제품X001 a kc:제품 ;
    kc:품질등급 "A" .
```

**Kcode에서 불러오기**

```han
온톨로지불러오기("relations.ttl", 형식=Turtle)
```

-----

### 2.1-4. 런타임 인스턴스 직접 삽입

파일 없이 실행 중에 인스턴스를 직접 추가할 수 있습니다.

```han
온톨로지삽입 개념=기계 인스턴스:
    이름 = "B003"
    온도 = 88.3
    가동중 = 참
온톨로지삽입끝
```

-----

## Layer 2.2 — Vector DB (벡터화 설정)

### 역할

어떤 데이터를 어떻게 벡터로 변환할지 개발자가 결정합니다.  
엔진은 이 설정을 기반으로 유사도 검색과 컨텍스트 회수를 수행합니다.

### 설정 항목

|항목     |설명                        |기본값      |
|-------|--------------------------|---------|
|임베딩 모델 |벡터화에 사용할 모델               |`내장기본`   |
|벡터화 대상 |어떤 속성을 벡터화할지              |모든 문자형 속성|
|유사도 임계값|유사하다고 판단하는 최소 점수 (0.0~1.0)|`0.75`   |
|벡터 차원  |임베딩 벡터의 크기                |`128`    |
|검색 상위 K|유사도 검색 시 반환할 최대 결과 수      |`5`      |

-----

### 2.2-1. 기본 설정

```han
벡터설정:
    임베딩모델 = "내장기본"     // 내장기본 | ONNX경로 | 외부API
    유사도임계값 = 0.75
    벡터차원 = 128
    검색상위K = 5
벡터설정끝
```

-----

### 2.2-2. 벡터화 대상 지정

모든 속성을 벡터화하면 성능이 저하될 수 있습니다.  
의미 검색이 필요한 속성만 지정하는 것을 권장합니다.

```han
벡터설정:
    임베딩모델 = "내장기본"
    유사도임계값 = 0.8

    // 벡터화할 속성 명시 지정
    벡터화대상:
        기계.상태         // 상태 텍스트 의미 검색
        불량품.원인       // 원인 유사 패턴 검색
        제품.품질등급     // 품질 등급 분류
    벡터화대상끝

    // 벡터화 제외 속성 (숫자/ID 등)
    벡터화제외:
        기계.온도         // 실수형 — 수치 비교로 처리
        제품.ID           // 고유 식별자 — 검색 불필요
    벡터화제외끝

벡터설정끝
```

-----

### 2.2-3. 외부 임베딩 모델 사용

**ONNX 모델 사용**

```han
벡터설정:
    임베딩모델 = "model/embedder.onnx"
    벡터차원 = 384
    유사도임계값 = 0.72
벡터설정끝
```

**외부 API 사용**

```han
벡터설정:
    임베딩모델 = "외부API"
    API주소 = "http://localhost:11434/api/embed"   // 예: Ollama
    모델명 = "nomic-embed-text"
    벡터차원 = 768
    유사도임계값 = 0.80
벡터설정끝
```

-----

### 2.2-4. 유사도 임계값 조정 기준

|임계값        |특성             |권장 상황    |
|-----------|---------------|---------|
|0.95 이상    |거의 동일한 것만 매칭   |정확한 중복 탐지|
|0.80 ~ 0.94|의미가 매우 유사한 것   |오류 패턴 분류 |
|0.65 ~ 0.79|관련 있는 것 폭넓게 매칭 |추천·연관 검색 |
|0.65 미만    |느슨한 매칭 (노이즈 증가)|탐색적 분석   |

-----

## Layer 2.3 — State / Log DB (상태·로그 설정)

### 역할

엔진의 실행 결과, 성공/실패 기록, 검증 결과를 어디에 어떻게 저장할지 설정합니다.  
이 기록이 Learning Loop(Layer 10)의 학습 재료가 됩니다.

> ⭐ 이 레이어는 엔진의 **경험 기억**입니다.  
> 설정하지 않으면 모든 실행 결과가 메모리에서만 유지되고 사라집니다.

-----

### 2.3-1. 기본 로그 설정

```han
로그설정:
    저장경로 = "logs/kcode_state.db"    // SQLite 기본
    보존기간 = 90일                      // 90일 이상 기록 자동 삭제
    최대크기 = 500MB
    자동백업 = 참
    백업경로 = "logs/backup/"
로그설정끝
```

-----

### 2.3-2. 기록 대상 선택

```han
로그설정:
    저장경로 = "logs/kcode_state.db"

    기록항목:
        실행결과 = 참      // 함수 실행 성공/실패
        검증결과 = 참      // Validation Layer PASS/FAIL
        추론경로 = 참      // 어떤 규칙으로 판단했는지
        오류상세 = 참      // 오류 발생 시 전체 컨텍스트
        성능측정 = 참      // 실행 시간, 메모리 사용량
        입력스냅샷 = 거짓  // 입력 데이터 원본 저장 (용량 주의)
    기록항목끝

로그설정끝
```

-----

### 2.3-3. 민감정보 보호 설정 ⚠️

학습 루프에 민감정보가 유입되지 않도록 반드시 설정합니다.  
설정하지 않으면 엔진이 민감 속성도 학습 재료로 사용할 수 있습니다.

```han
로그설정:
    저장경로 = "logs/kcode_state.db"

    민감정보보호:
        // 절대 기록하지 않을 속성
        제외속성 = [사용자.비밀번호, 사용자.주민번호, 결제.카드번호]

        // 기록 전 익명화할 속성
        익명화 = [사용자.이름, 사용자.이메일, 작업자.ID]

        // 학습에서 완전 제외할 개념
        학습제외개념 = [개인정보, 결제정보, 의료기록]

        // 감사 로그 (누가 무엇을 요청했는지만 기록)
        감사로그 = 참
        감사로그경로 = "logs/audit.log"
    민감정보보호끝

로그설정끝
```

> **규정 준수**: GDPR / 개인정보보호법 대응 시  
> `익명화`와 `감사로그`를 반드시 활성화하세요.

-----

### 2.3-4. 학습 허용 범위 설정

엔진이 기록을 바탕으로 어떤 학습을 허용할지 결정합니다.

```han
로그설정:
    저장경로 = "logs/kcode_state.db"

    학습정책:
        자동규칙생성 = 참       // 패턴 발견 시 온톨로지 규칙 자동 등록
        학습최소샘플 = 50       // 최소 50회 이상 관측된 패턴만 학습
        학습신뢰도임계 = 0.85   // 85% 이상 일관된 패턴만 규칙으로 등록
        학습승인방식 = 자동      // 자동 | 수동검토 | 알림후자동
        규칙만료일 = 180일      // 180일 이상 사용 안 된 학습 규칙 자동 삭제
    학습정책끝

로그설정끝
```

**학습 승인 방식 비교**

|방식     |설명                       |권장 상황            |
|-------|-------------------------|-----------------|
|`자동`   |조건 충족 시 즉시 규칙 등록         |개발/테스트 환경        |
|`수동검토` |개발자 승인 후 등록              |운영 환경 (안전 중요 시스템)|
|`알림후자동`|알림 발송 후 24시간 이의 없으면 자동 등록|일반 운영 환경         |

-----

### 2.3-5. 저장 백엔드 선택

```han
로그설정:
    // SQLite (기본 — 단일 파일, 설치 불필요)
    저장백엔드 = SQLite
    저장경로 = "logs/kcode_state.db"

    // 또는 외부 DB 연결
    // 저장백엔드 = PostgreSQL
    // DB주소 = "localhost:5432"
    // DB이름 = "kcode_log"
    // DB사용자 = "kcode"
    // DB비밀번호 = 환경변수("DB_PW")   // 비밀번호는 환경변수 권장

로그설정끝
```

-----

## 전체 설정 통합 예시

실제 프로젝트에서 4개 레이어를 함께 설정하는 완성 예시입니다.

```han
// ─────────────────────────────────────────────
// Layer 1: Semantic Layer — 의미 정의
// ─────────────────────────────────────────────
온톨로지 "스마트공장v1":

    개념 장비
    개념 기계 상위=장비 속성=[이름:문자, 온도:실수, 가동중:논리]
    개념 센서 상위=장비 속성=[ID:문자, 측정값:실수]
    개념 제품 속성=[ID:문자, 품질등급:문자]
    개념 불량품 상위=제품 속성=[원인:문자, 감지시간:정수]
    개념 작업자 속성=[이름:문자, 권한등급:정수]

    관계 기계 → 생산 → 제품
    관계 기계 → 감지 → 불량품
    관계 센서 → 측정 → 기계
    관계 작업자 → 운영 → 기계

    제약 온도 < 150.0
    제약 권한등급 >= 1

온톨로지끝

// ─────────────────────────────────────────────
// Layer 2.1: Ontology DB — 초기 데이터 로드
// ─────────────────────────────────────────────
온톨로지불러오기("data/machines.csv", 형식=CSV, 유형열="유형")
온톨로지불러오기("data/relations.ttl", 형식=Turtle)

// ─────────────────────────────────────────────
// Layer 2.2: Vector DB — 벡터화 설정
// ─────────────────────────────────────────────
벡터설정:
    임베딩모델 = "내장기본"
    유사도임계값 = 0.80
    벡터차원 = 128
    검색상위K = 5

    벡터화대상:
        기계.상태
        불량품.원인
    벡터화대상끝

    벡터화제외:
        기계.온도
        제품.ID
        센서.측정값
    벡터화제외끝

벡터설정끝

// ─────────────────────────────────────────────
// Layer 2.3: State/Log DB — 기록 · 학습 정책
// ─────────────────────────────────────────────
로그설정:
    저장백엔드 = SQLite
    저장경로 = "logs/factory_state.db"
    보존기간 = 90일
    최대크기 = 200MB

    기록항목:
        실행결과 = 참
        검증결과 = 참
        추론경로 = 참
        오류상세 = 참
        입력스냅샷 = 거짓
    기록항목끝

    민감정보보호:
        제외속성 = [작업자.주민번호]
        익명화 = [작업자.이름]
        감사로그 = 참
        감사로그경로 = "logs/audit.log"
    민감정보보호끝

    학습정책:
        자동규칙생성 = 참
        학습최소샘플 = 30
        학습신뢰도임계 = 0.85
        학습승인방식 = 알림후자동
        규칙만료일 = 180일
    학습정책끝

로그설정끝
```

-----

## 설정 체크리스트

프로젝트 시작 전 아래 항목을 확인하세요.

### Layer 1 — Semantic Layer

- [ ] 시스템에 등장하는 모든 개념 선언 완료
- [ ] 개념 간 관계 방향 정의 완료
- [ ] 물리적·논리적 제약 조건 선언 완료
- [ ] 개념 상속 구조 설계 완료 (해당 시)

### Layer 2.1 — Ontology DB

- [ ] 초기 데이터 파일 포맷 결정 (CSV / JSON-LD / Turtle / OWL)
- [ ] 데이터 파일 경로 확인
- [ ] 런타임 삽입이 필요한 인스턴스 파악 완료

### Layer 2.2 — Vector DB

- [ ] 임베딩 모델 선택 완료 (내장기본 / ONNX / 외부API)
- [ ] 벡터화 대상 속성 지정 완료
- [ ] 유사도 임계값 결정 완료 (권장: 0.75 ~ 0.85)
- [ ] 수치형·ID 속성 벡터화 제외 처리 완료

### Layer 2.3 — State/Log DB

- [ ] 로그 저장 경로 및 용량 계획 수립
- [ ] 민감정보 제외·익명화 속성 목록 확정
- [ ] 학습 승인 방식 결정 (자동 / 수동 / 알림후자동)
- [ ] 학습 신뢰도 임계값 설정 완료
- [ ] 감사 로그 활성화 여부 결정 (규정 준수 필요 시 필수)

-----

## 자주 묻는 질문

**Q. Layer 1의 개념 정의를 나중에 변경할 수 있나요?**  
A. 가능합니다. 단, 이미 벡터화된 인스턴스는 재벡터화가 필요합니다. 속성 삭제 시 기존 인스턴스 데이터에 영향을 줄 수 있으므로 운영 중 변경은 신중하게 진행하세요.

**Q. 벡터화 대상을 지정하지 않으면 어떻게 되나요?**  
A. 모든 문자형 속성이 자동으로 벡터화됩니다. 성능에 민감한 환경에서는 반드시 필요한 속성만 지정하는 것을 권장합니다.

**Q. 민감정보 설정을 하지 않으면 어떤 위험이 있나요?**  
A. 학습 루프가 민감 속성까지 패턴으로 학습할 수 있습니다. 이는 의도치 않은 개인정보 노출이나 규정 위반으로 이어질 수 있습니다. 운영 환경에서는 반드시 설정하세요.

**Q. 외부 임베딩 API 연결 시 인터넷이 없는 환경은 어떻게 하나요?**  
A. `내장기본` 모드 또는 로컬 ONNX 모델 경로를 지정하면 오프라인 환경에서도 동작합니다.

**Q. 학습 규칙이 잘못 생성되면 어떻게 되나요?**  
A. `학습승인방식 = 수동검토`로 설정하면 모든 학습 규칙을 개발자가 검토 후 등록할 수 있습니다. `규칙만료일`을 설정하면 오래된 규칙은 자동 삭제됩니다.

-----

*Kcode v18.7.0 — Concept Identity / Vector Space 사용자 설정 가이드*